<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Millo's "Hit the Wall" - Survival</title>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Press Start 2P', 'Courier New', monospace;
            margin: 0;
            overflow: hidden;
            background-color: #000000; 
            color: #E0E0FF; 
            font-size: 10px; 
        }
        #gameContainer {
            width: 100vw;
            height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            position: relative;
        }
        #gameCanvas {
            border: 2px solid #303050; 
            background-color: #000;
            image-rendering: pixelated;
            image-rendering: -moz-crisp-edges;
            image-rendering: crisp-edges;
            max-width: 100%; 
            max-height: calc(100vh - 150px); 
        }
        .screen-panel {
            background-color: rgba(15, 15, 30, 0.92); 
            border: 2px solid #505070; 
            padding: 20px 30px; 
            border-radius: 0px; 
            box-shadow: 4px 4px 0px #202040; 
            max-width: 90%;
            color: #FFFFFF;
            text-align: center;
        }
        #titleScreen { 
            max-width: 480px; 
            padding: 25px 35px; 
            cursor: pointer;
        }
        #logoCanvas {
            width: 400px; 
            max-width: 90%; 
            height: 180px; 
            margin-bottom: 25px; 
            image-rendering: pixelated;
            border: 2px solid #202040; 
            background-color: #080810; 
        }
        .title-text-small { 
             font-size: 18px;
             text-shadow: 1px 1px 0px #DDA0DD, 2px 2px 0px #800080; 
             color: #FFF0F5; 
             margin-bottom: 10px;
             line-height: 1.2;
        }
        .screen-panel p {
            font-size: 10px; 
            line-height: 1.6;
        }
        #pressStartPrompt {
            font-size: 16px; 
            color: #FFFF00; 
            text-shadow: 1px 1px 0px #CCAA00;
            margin-top: 30px; 
            animation: blinkPrompt 1.2s infinite;
        }
        @keyframes blinkPrompt {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.4; }
        }
        .controls-text {
            font-size: 10px; 
            color: #B0B0D0; 
            margin-top: 20px; 
        }

        #gameplayScreen { 
            width: 100vw;
            height: 100vh;
            position: absolute; 
            top: 0;
            left: 0;
            display: flex; 
            flex-direction: column;
            align-items: center;
            justify-content: flex-start; 
            z-index: 2; 
        }
        #gameUiContainer { 
            width: 90%;
            max-width: 450px; 
            margin-top: 10px; 
            margin-bottom: 8px;
            z-index: 3; 
            position: relative; 
            pointer-events: none; 
        }
        #gameUiContainer > * {
            pointer-events: auto; 
        }
        .game-stats {
            display: flex;
            justify-content: space-around;
            align-items: center; 
            width: 100%;
            font-size: 12px; 
            color: #E0E0FF; 
            background-color: rgba(15, 15, 30, 0.85); 
            padding: 5px 8px; 
            border: 1px solid #505070;
            border-radius: 0px; 
            margin-bottom: 5px; 
            box-shadow: 2px 2px 0px #202040;
        }
        #timerProgressBarContainer {
            width: 100px; 
            height: 12px; 
            background-color: #333; 
            border: 1px solid #505070;
            border-radius: 0px;
            overflow: hidden; 
            margin-left: 10px; 
        }
        #timerProgressBar {
            width: 100%; 
            height: 100%;
            background-color: #4CAF50; 
            transition: width 0.2s linear, background-color 0.5s linear; 
        }
        #messageDisplay {
            font-size: 10px; 
            text-shadow: 1px 1px 1px rgba(0,0,0,0.5);
            background-color: rgba(15, 15, 30, 0.85); 
            padding: 4px 8px;
            border-radius: 0px;
            border: 1px solid #505070;
            min-height: 2.5em; 
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100%;
            box-shadow: 2px 2px 0px #202040;
        }
        
        #finalScoreDisplay { 
            font-size: 28px; 
            color: #FFFF00; 
            text-shadow: 2px 2px 0px #FF8C00; 
            margin: 8px 0;
        }
        .stats-grid { 
            display: grid;
            grid-template-columns: 1fr; /* Simplified to one column for basic stats */
            gap: 5px; 
            font-size: 12px; /* Slightly larger for main stats */
            margin-top: 10px;
            text-align: center; /* Center stats */
        }
        .stats-grid span {
            color: #FFFF88; 
        }
        
        .pixel-button { 
            background-color: #4A90E2; 
            color: white;
            padding: 8px 16px; 
            border-radius: 0px;
            border: 2px solid #1E63B0; 
            box-shadow: 2px 2px 0px #1E63B0; 
            transition: all 0.05s ease-out; 
            cursor: pointer;
            font-size: 12px; 
            line-height: 1.2;
            margin: 5px; 
        }
        .pixel-button:hover, .pixel-button:active { 
            background-color: #357ABD;
            box-shadow: 1px 1px 0px #1E63B0;
            transform: translate(1px, 1px); 
        }
        .pixel-button.green {
             background-color: #50C878; 
             border-color: #2E8B57;
             box-shadow: 2px 2px 0px #2E8B57;
        }
        .pixel-button.green:hover, .pixel-button.green:active {
            background-color: #3CB371;
            box-shadow: 1px 1px 0px #2E8B57;
        }

        #onScreenControls {
            width: 100%;
            position: fixed;
            bottom: 0;
            left: 0;
            z-index: 10; 
            padding: 10px;
            box-sizing: border-box;
            display: none; 
            justify-content: space-between; 
            align-items: flex-end; 
            pointer-events: none; 
        }
        .control-cluster {
            display: flex;
            gap: 10px;
            pointer-events: auto; 
            background-color: rgba(10,10,20,0.6); 
            padding: 8px;
            border-radius: 5px;
        }
        #leftControls {
            flex-direction: column; 
        }
        #rightControls {
            flex-direction: row; 
        }

        .control-button { 
            width: 55px; 
            height: 55px;
            background-color: #303050; 
            border: 2px solid #7070A0; 
            box-shadow: 0px 2px 0px #181828;
            color: #E0E0FF;
            font-size: 24px; 
            display: flex;
            align-items: center;
            justify-content: center;
            user-select: none; 
            -webkit-user-select: none; 
            touch-action: manipulation; 
            border-radius: 4px; 
        }
        .control-button.active, .control-button:active { 
            background-color: #505070; 
            box-shadow: inset 0px 1px 2px #181828; 
            transform: translateY(1px);
        }
      
        @media (max-width: 768px) { 
            .controls-text { display: none; }
            #titleScreen { padding: 15px; max-width: 95%; } 
            #logoCanvas { width: 90%; height: auto; aspect-ratio: 450 / 180; margin-bottom: 20px;} 
            #pressStartPrompt { font-size: 14px; margin-top: 25px;}
            .screen-panel p, #titleScreen p { font-size: 10px; } 
            .game-stats { font-size: 10px; max-width: 90%; } 
            #messageDisplay { font-size: 10px; max-width: 90%; }
            #finalScoreDisplay { font-size: 28px; }
            .pixel-button { font-size: 10px; padding: 6px 12px; }
            #timerProgressBarContainer { width: 80px; height: 10px; }
            .stats-grid { grid-template-columns: 1fr; font-size: 9px; } 
        }
         @media (max-height: 450px) and (orientation: landscape) { 
            #onScreenControls { bottom: 5px; transform: translateX(-50%) scale(0.75); } 
            .game-stats { font-size: 10px; padding: 4px 8px; }
            #messageDisplay { font-size: 9px; padding: 3px 6px; }
            #timerProgressBarContainer { width: 70px; height: 8px; }
             #logoCanvas { height: 150px; margin-bottom: 15px;} 
             #pressStartPrompt { margin-top: 15px; font-size: 12px;}
             .controls-text { margin-top: 10px; font-size: 8px;}
        }
    </style>
</head>
<body class="select-none">
    <audio id="menuMusic" loop src="menu_music.mp3"></audio> 
    <audio id="gameplayMusic" loop src="millo_theme.mp3"></audio> 
    <audio id="endMenuMusic" loop src="end-menu-music.mp3"></audio>
    <audio id="cdPickupSound" src="cd.mp3"></audio>
    <audio id="goldenCdPickupSound" src="golden-cd.mp3"></audio>
    <audio id="xraySpecsSound" src="YOUR_XRAY_SFX.wav"></audio> 
    <audio id="gooPuddleSound" src="YOUR_GOO_SFX.wav"></audio> 
    <audio id="timeFreezeSound" src="YOUR_TIME_FREEZE_SFX.wav"></audio> 
    <audio id="pathfinderSound" src="YOUR_PATHFINDER_SFX.wav"></audio> 
    <audio id="cursedIdolSound" src="YOUR_CURSED_IDOL_SFX.wav"></audio> 


    <div id="gameContainer">
        <div id="titleScreen" class="screen-panel"> 
            <canvas id="logoCanvas"></canvas>
            <p id="pressStartPrompt">PRESS ENTER TO START</p>
            <p class="controls-text"><strong class="text-yellow-300">Controls:</strong> Arrow Keys or W/A/S/D</p>
        </div>

        <div id="gameplayScreen" class="hidden"> 
            <canvas id="gameCanvas"></canvas> 
            <div id="gameUiContainer">
                <div class="game-stats"> 
                    <div id="timerDisplay">Time: 30</div> 
                    <div id="timerProgressBarContainer">
                        <div id="timerProgressBar"></div>
                    </div>
                    <div id="scoreDisplay">CDs: 0</div>
                </div>
                <p id="messageDisplay" class="min-h-[2em]"></p>
            </div>
        </div>
        
        <div id="gameOverScreen" class="hidden screen-panel p-5">
            <h2 class="title-text-small" style="font-size: 20px; margin-bottom: 8px;">Game Over!</h2> 
            <div id="scoreSection">
                <div id="finalScoreDisplay">0s Survived</div> 
                <div class="stats-grid">
                    <div>CDs Collected: <span id="statCDsCollected">0</span></div>
                    </div>
                <p id="gameOverMessage" class="mt-4 mb-3 min-h-[2em] flex items-center justify-center" style="font-size:10px;"></p>
            </div>
            
            <div class="flex flex-col sm:flex-row justify-center items-center mt-2"> 
                <button id="restartButton" class="pixel-button green">Play Again?</button>
                <button id="shareScoreButton" class="pixel-button">Share Score</button>
                <a href="https://open.spotify.com/artist/5DqBbDMaCLIJEswvNl07Ys?si=hz3sJ7GZQ4mpl0VGdtiNKg" target="_blank" id="listenMusicButton" class="pixel-button" style="background-color: #1DB954; border-color: #107A38; box-shadow: 2px 2px 0px #107A38;">Listen to Millo!</a>
            </div>
        </div>
    </div>

    <div id="onScreenControls">
        <div id="leftControls" class="control-cluster">
            <button id="arrowUp" class="control-button">▲</button>
            <button id="arrowDown" class="control-button">▼</button>
        </div>
        <div id="rightControls" class="control-cluster">
            <button id="arrowLeft" class="control-button">◀</button>
            <button id="arrowRight" class="control-button">▶</button>
        </div>
    </div>

    <script type="module">
        // --- DOM Elements ---
        const titleScreen = document.getElementById('titleScreen');
        const gameplayScreen = document.getElementById('gameplayScreen');
        const gameOverScreen = document.getElementById('gameOverScreen');
        const restartButton = document.getElementById('restartButton');
        const mainCanvas = document.getElementById('gameCanvas'); 
        const messageDisplay = document.getElementById('messageDisplay');
        const timerDisplay = document.getElementById('timerDisplay');
        const timerProgressBar = document.getElementById('timerProgressBar'); 
        const scoreDisplay = document.getElementById('scoreDisplay'); 
        const finalScoreDisplay = document.getElementById('finalScoreDisplay'); 
        const gameOverMessage = document.getElementById('gameOverMessage');
        const logoCanvas = document.getElementById('logoCanvas');
        const arrowUpButton = document.getElementById('arrowUp');
        const arrowDownButton = document.getElementById('arrowDown');
        const arrowLeftButton = document.getElementById('arrowLeft');
        const arrowRightButton = document.getElementById('arrowRight');
        const shareScoreButton = document.getElementById('shareScoreButton');
        const menuMusic = document.getElementById('menuMusic'); 
        const gameplayMusic = document.getElementById('gameplayMusic'); 
        const endMenuMusic = document.getElementById('endMenuMusic');
        const cdPickupSound = document.getElementById('cdPickupSound');
        const goldenCdPickupSound = document.getElementById('goldenCdPickupSound');
        const xraySpecsSound = document.getElementById('xraySpecsSound');
        const gooPuddleSound = document.getElementById('gooPuddleSound');
        const timeFreezeSound = document.getElementById('timeFreezeSound');
        const pathfinderSound = document.getElementById('pathfinderSound');
        const cursedIdolSound = document.getElementById('cursedIdolSound');
        const onScreenControls = document.getElementById('onScreenControls'); 
        const statCDsCollected = document.getElementById('statCDsCollected'); // For simplified game over stats
        
        // --- Offscreen Canvas for 3D Pixelation ---
        const offscreenCanvas = document.createElement('canvas'); 
        const offscreenCtx = offscreenCanvas.getContext('2d');

        // --- Game Configuration ---
        const RENDER_WIDTH = 160, RENDER_HEIGHT = 120; 
        const TILE_SIZE = 64; 
        const FOV = Math.PI / 3;
        let MOVE_SPEED = TILE_SIZE / 9; 
        const ORIGINAL_MOVE_SPEED = TILE_SIZE / 9; 
        const TURN_SPEED = 0.06, NUM_RAYS = RENDER_WIDTH;
        const INITIAL_TIME = 30; 
        const TIME_PER_CD = 5; 
        const TIME_PER_GOLDEN_CD = 10; 
        const PA_ANNOUNCEMENT_INTERVAL = 17000;
        const GOLDEN_CD_BASE_THRESHOLD = 1; 
        const GOLDEN_CD_POINTS_VALUE = 5; 
        const XRAY_DURATION = 10000; 
        const SLOWDOWN_DURATION = 3000; 
        const TIME_FREEZE_DURATION = 7000; 
        const PATHFINDER_DURATION = 10000; 
        const FOG_DURATION = 8000; 

        // --- Game State ---
        let player = { x: 0, y: 0, angle: 0 };
        let gameMap = [];
        let cdPosition = { x: 0, y: 0, active: false, isGolden: false };
        let xraySpecsPosition = { x: 0, y: 0, active: false, type: 'xray' }; 
        let gooPuddles = []; 
        const MAX_GOO_PUDDLES = 2; 
        let timeFreezePosition = { x:0, y:0, active: false, type: 'timeFreeze'};
        let pathfinderPosition = { x:0, y:0, active: false, type: 'pathfinder'};
        let cursedIdolPosition = { x:0, y:0, active: false, type: 'cursedIdol'}; 
        const POWERUP_SPAWN_CHANCE = 0.15; 

        let score = 0; // Total CDs collected (for display during gameplay)
        let timeLeft = INITIAL_TIME;
        let totalTimePlayedInSeconds = 0;
        // Removed detailed stat tracking variables like goldenCDsCollectedCount, etc. as they are not displayed

        let gameRunning = false, gameTimerInterval = null, paAnnouncementTimer = null; 
        let nextGoldenCDAfter = GOLDEN_CD_BASE_THRESHOLD; 
        let regularCDsCollectedForGoldenTrigger = 0; // Still needed for Golden CD logic

        let isXRayModeActive = false;
        let xRayTimerId = null;
        let isSlowed = false;
        let slowdownTimerId = null;
        let isTimeFrozen = false;
        let timeFreezeEffectTimerId = null;
        let isPathfinderActive = false;
        let pathfinderTimerId = null;
        let isFogActive = false;
        let fogTimerId = null;
        let particles = []; 

        // --- Baked-in PA Announcements ---
        const paAnnouncementsList = [ 
            "The pink walls are humming...","CDs extend your stay.","Time is... relative here.",
            "Caution: Floor may be surprisingly green.","Remember to breathe... or don't.",
            "Lost items can be found... eventually.","Enjoy your non-Euclidean shopping experience!",
            "The food court is experiencing... temporal distortions.","Please keep all appendages inside the reality.",
            "Today's special: Existential dread with a side of static."
        ];

        // --- Colors & Textures ---
        const ARCADE_PINK_WALL_1 = '#FF69B4', ARCADE_PINK_WALL_2 = '#DB7093'; 
        const PS1_GREEN_CARPET_1 = '#2E8B57', PS1_GREEN_CARPET_2 = '#228B22'; 
        const PS1_NIGHT_SKY_1 = '#191970', PS1_NIGHT_SKY_2 = '#000033'; 
        const XRAY_WALL_COLOR = 'rgba(100, 100, 255, 0.2)'; 
        const XRAY_WALL_OUTLINE_COLOR = 'rgba(150, 150, 255, 0.5)';

        const textures = {
            wall: createTexture(ARCADE_PINK_WALL_1, ARCADE_PINK_WALL_2, false, true),
            floor: createTexture(PS1_GREEN_CARPET_1, PS1_GREEN_CARPET_2, true),
            ceiling: createNightSkyTexture(PS1_NIGHT_SKY_1, PS1_NIGHT_SKY_2),
            cdSprite: createReflectiveCDSpriteEnhanced(),
            goldenCdSprite: createGoldenCDSprite(),
            xraySpecsSprite: createXRaySpecsSprite(), 
            gooPuddleSprite: createGooPuddleSprite(),
            timeFreezeSprite: createTimeFreezeSprite(),
            pathfinderSprite: createPathfinderSprite(),
            cursedIdolSprite: createCursedIdolSprite()
        };

        // --- Drawing Functions ---
        function drawPixelCursiveLogo() { 
            const ctx = logoCanvas.getContext('2d'); const cw = logoCanvas.width; const ch = logoCanvas.height; ctx.imageSmoothingEnabled = false; ctx.clearRect(0,0,cw,ch);
            const startViewPlayer = { x: TILE_SIZE * 1.5, y: TILE_SIZE * 1.5, angle: Math.PI / 4 }; const tempOffscreen = document.createElement('canvas'); tempOffscreen.width = RENDER_WIDTH; tempOffscreen.height = RENDER_HEIGHT; const tempCtx = tempOffscreen.getContext('2d'); tempCtx.imageSmoothingEnabled = false;
            tempCtx.drawImage(textures.ceiling,0,0,RENDER_WIDTH,RENDER_HEIGHT/2); tempCtx.drawImage(textures.floor,0,RENDER_HEIGHT/2,RENDER_WIDTH,RENDER_HEIGHT/2);
            for(let i=0; i < NUM_RAYS; i++) { const rayAngle = startViewPlayer.angle - FOV/2 + (i/NUM_RAYS) * FOV; let distToWall = 0, hitWall = false, hitEdge = false; const eyeX = Math.cos(rayAngle), eyeY = Math.sin(rayAngle);
                while(!hitWall && distToWall < TILE_SIZE * 5){ distToWall += 2; const testX = Math.floor((startViewPlayer.x + eyeX * distToWall) / TILE_SIZE); const testY = Math.floor((startViewPlayer.y + eyeY * distToWall) / TILE_SIZE); if(testX<0||testX>=MAP_WIDTH||testY<0||testY>=MAP_HEIGHT){hitWall=true; distToWall=TILE_SIZE*5;} else if(MAP_DATA[testY] && MAP_DATA[testY][testX]===1){ hitWall=true; }}
                const correctedDist = distToWall * Math.cos(rayAngle - startViewPlayer.angle); const wallHeight = Math.min(RENDER_HEIGHT, (TILE_SIZE / correctedDist) * RENDER_HEIGHT * 0.8); const wallTop = (RENDER_HEIGHT/2) - wallHeight/2; const wallHitX = startViewPlayer.x + eyeX * distToWall; const wallHitY = startViewPlayer.y + eyeY * distToWall; let textureX = Math.floor(hitEdge ? wallHitX % TILE_SIZE : wallHitY % TILE_SIZE); tempCtx.drawImage(textures.wall, textureX,0,1,TILE_SIZE, i,wallTop,1,wallHeight); const shadeFactor = Math.max(0.1, 1 - (correctedDist/(TILE_SIZE*4))); tempCtx.fillStyle = `rgba(25,0,25,${1-shadeFactor*0.7})`; tempCtx.fillRect(i,wallTop,1,wallHeight);
            } ctx.drawImage(tempOffscreen, 0, 0, cw, ch); 
            ctx.textAlign = "center"; ctx.textBaseline = "middle"; const millosY = ch * 0.35; ctx.font = "24px 'Press Start 2P'"; ctx.fillStyle = "#800080"; ctx.fillText("Millo's", cw * 0.5 + 2, millosY + 2); ctx.fillStyle = "#FFF0F5"; ctx.fillText("Millo's", cw * 0.5, millosY);
            const htwY = ch * 0.65; const hitTheWallFontSize = 38; ctx.font = `${hitTheWallFontSize}px 'Press Start 2P'`; const shadowOffset = 3; ctx.fillStyle = "#FF1493"; ctx.fillText("Hit the Wall", cw * 0.5 + shadowOffset, htwY + shadowOffset); ctx.fillStyle = "#FFFF00"; ctx.fillText("Hit the Wall", cw * 0.5, htwY);
        }

        function createTexture(c1, c2, isChk = false, isW = false) { 
            const cvs = document.createElement('canvas'); cvs.width=TILE_SIZE; cvs.height=TILE_SIZE; const ctx=cvs.getContext('2d');
            if(isChk){const cs=TILE_SIZE/(isW?4:2);for(let y=0;y<(isW?4:2);y++)for(let x=0;x<(isW?4:2);x++){ctx.fillStyle=(x+y)%2===0?c1:c2;ctx.fillRect(x*cs,y*cs,cs,cs);}
                if(!isW){for(let i=0;i<30;i++){ctx.fillStyle=Math.random()<0.5?c1:c2;ctx.globalAlpha=0.25;ctx.fillRect(Math.random()*TILE_SIZE,Math.random()*TILE_SIZE,1,Math.random()*3+1);}ctx.globalAlpha=1;}}
            else{ctx.fillStyle=c1;ctx.fillRect(0,0,TILE_SIZE,TILE_SIZE);for(let i=0;i<TILE_SIZE*TILE_SIZE/6;i++){ctx.fillStyle=c2;ctx.globalAlpha=Math.random()*0.5+0.2;ctx.fillRect(Math.random()*TILE_SIZE,Math.random()*TILE_SIZE,1,1);}ctx.globalAlpha=1;}
            if(isW){ctx.strokeStyle='rgba(0,0,0,0.2)';ctx.lineWidth=1;for(let i=TILE_SIZE/2;i<TILE_SIZE;i+=TILE_SIZE/2){ctx.beginPath();ctx.moveTo(i,0);ctx.lineTo(i,TILE_SIZE);ctx.stroke();ctx.beginPath();ctx.moveTo(0,i);ctx.lineTo(TILE_SIZE,i);ctx.stroke();}}
            return cvs;
        }
        function createNightSkyTexture(c1,c2){ 
            const cvs=document.createElement('canvas');cvs.width=TILE_SIZE*2;cvs.height=TILE_SIZE;const ctx=cvs.getContext('2d');
            const gr=ctx.createLinearGradient(0,0,0,TILE_SIZE);gr.addColorStop(0,c2);gr.addColorStop(0.7,c1);gr.addColorStop(1,c1);ctx.fillStyle=gr;ctx.fillRect(0,0,cvs.width,cvs.height);
            for(let i=0;i<100;i++){const x=Math.random()*cvs.width,y=Math.random()*cvs.height*0.8,s=Math.random()*1.2+0.3;ctx.fillStyle=`rgba(255,255,${Math.floor(Math.random()*55+200)},${Math.random()*0.6+0.4})`;ctx.beginPath();ctx.arc(x,y,s,0,Math.PI*2);ctx.fill();}
            return cvs;
        }
        function createReflectiveCDSpriteEnhanced(){ 
            const cvs=document.createElement('canvas');cvs.width=TILE_SIZE;cvs.height=TILE_SIZE;const ctx=cvs.getContext('2d');
            const cX=TILE_SIZE/2,cY=TILE_SIZE/2,oR=TILE_SIZE*0.45,iR=TILE_SIZE*0.1;
            const gr=ctx.createRadialGradient(cX,cY,iR,cX,cY,oR);gr.addColorStop(0,'#DDDDFF');gr.addColorStop(0.6,'#A0A0CC');gr.addColorStop(1,'#C0C0EE');ctx.fillStyle=gr;ctx.beginPath();ctx.arc(cX,cY,oR,0,Math.PI*2);ctx.fill();
            const sC=['rgba(255,0,0,0.2)','rgba(255,165,0,0.2)','rgba(255,255,0,0.2)','rgba(0,128,0,0.2)','rgba(0,0,255,0.2)','rgba(75,0,130,0.2)','rgba(238,130,238,0.2)'];
            for(let i=0;i<7;i++){ctx.beginPath();const aO=(i/7)*Math.PI*0.3,sA=Math.PI*(0.2+i*0.2)+aO,eA=sA+Math.PI*0.3,r=oR*(0.6+Math.random()*0.3);ctx.arc(cX,cY,r,sA,eA);ctx.strokeStyle=sC[i%sC.length];ctx.lineWidth=TILE_SIZE*0.05*(Math.random()*0.5+0.5);ctx.stroke();}
            ctx.fillStyle='#202030';ctx.beginPath();ctx.arc(cX,cY,iR,0,Math.PI*2);ctx.fill();ctx.strokeStyle='#101015';ctx.lineWidth=1;ctx.stroke();
            ctx.strokeStyle='rgba(255,255,255,0.5)';ctx.lineWidth=TILE_SIZE*0.015;ctx.beginPath();ctx.arc(cX,cY,oR,0,Math.PI*2);ctx.stroke();
            return cvs;
        }
        function createGoldenCDSprite(){ 
            const cvs=document.createElement('canvas');cvs.width=TILE_SIZE;cvs.height=TILE_SIZE;const ctx=cvs.getContext('2d');
            const cX=TILE_SIZE/2,cY=TILE_SIZE/2,oR=TILE_SIZE*0.45,iR=TILE_SIZE*0.1;
            const gr=ctx.createRadialGradient(cX,cY,iR*0.5,cX,cY,oR);gr.addColorStop(0,'#FFFFE0');gr.addColorStop(0.5,'#FFD700');gr.addColorStop(1,'#FFA500');ctx.fillStyle=gr;
            ctx.beginPath();ctx.arc(cX,cY,oR,0,Math.PI*2);ctx.fill();
            for(let i=0;i<12;i++){ctx.beginPath();const a=(i/12)*Math.PI*2;ctx.moveTo(cX+Math.cos(a)*iR,cY+Math.sin(a)*iR);ctx.lineTo(cX+Math.cos(a+0.1)*oR*0.95,cY+Math.sin(a+0.1)*oR*0.95);ctx.strokeStyle=`rgba(255,255,180,${0.2+Math.random()*0.3})`;ctx.lineWidth=TILE_SIZE*0.02;ctx.stroke();}
            ctx.fillStyle='#4A2C00';ctx.beginPath();ctx.arc(cX,cY,iR,0,Math.PI*2);ctx.fill();
            ctx.strokeStyle='#DAA520';ctx.lineWidth=TILE_SIZE*0.02;ctx.beginPath();ctx.arc(cX,cY,oR,0,Math.PI*2);ctx.stroke();
            for(let i=0; i<5; i++){ ctx.fillStyle = `rgba(255,255,224,${0.5 + Math.random()*0.5})`; const sX = cX + (Math.random()-0.5)*oR*1.5; const sY = cY + (Math.random()-0.5)*oR*1.5; const sS = TILE_SIZE * (0.02 + Math.random()*0.03); ctx.fillRect(sX-sS/2, sY-sS/2, sS,sS);}
            return cvs;
        }
        function createXRaySpecsSprite() { 
            const spriteCanvas = document.createElement('canvas'); spriteCanvas.width = TILE_SIZE; spriteCanvas.height = TILE_SIZE; const ctx = spriteCanvas.getContext('2d');
            const lensRadius = TILE_SIZE*0.2; const frameColor = '#40E0D0'; const lensColor = 'rgba(173,216,230,0.5)'; ctx.strokeStyle=frameColor; ctx.lineWidth=TILE_SIZE*0.05;
            ctx.beginPath();ctx.arc(TILE_SIZE*0.3,TILE_SIZE*0.5,lensRadius,0,Math.PI*2);ctx.stroke(); ctx.beginPath();ctx.arc(TILE_SIZE*0.7,TILE_SIZE*0.5,lensRadius,0,Math.PI*2);ctx.stroke();
            ctx.beginPath();ctx.moveTo(TILE_SIZE*0.3+lensRadius,TILE_SIZE*0.5);ctx.lineTo(TILE_SIZE*0.7-lensRadius,TILE_SIZE*0.5);ctx.stroke();
            ctx.fillStyle=lensColor; ctx.beginPath();ctx.arc(TILE_SIZE*0.3,TILE_SIZE*0.5,lensRadius*0.9,0,Math.PI*2);ctx.fill(); ctx.beginPath();ctx.arc(TILE_SIZE*0.7,TILE_SIZE*0.5,lensRadius*0.9,0,Math.PI*2);ctx.fill();
            return spriteCanvas;
        }
        function createGooPuddleSprite() { 
            const spriteCanvas = document.createElement('canvas'); spriteCanvas.width = TILE_SIZE; spriteCanvas.height = TILE_SIZE; const ctx = spriteCanvas.getContext('2d');
            ctx.fillStyle='#556B2F'; ctx.beginPath(); ctx.ellipse(TILE_SIZE/2,TILE_SIZE*0.7,TILE_SIZE*0.4,TILE_SIZE*0.2,0,0,Math.PI*2); ctx.fill();
            ctx.fillStyle='#8FBC8F'; for(let i=0;i<3;i++){ctx.beginPath(); ctx.ellipse(TILE_SIZE/2+(Math.random()-0.5)*20,TILE_SIZE*0.7+(Math.random()-0.5)*10,TILE_SIZE*0.05,TILE_SIZE*0.03,Math.random()*Math.PI,0,Math.PI*2); ctx.fill();}
            return spriteCanvas;
        }
        function createTimeFreezeSprite() {
            const spriteCanvas = document.createElement('canvas'); spriteCanvas.width = TILE_SIZE; spriteCanvas.height = TILE_SIZE; const ctx = spriteCanvas.getContext('2d');
            ctx.fillStyle = '#ADD8E6'; 
            ctx.beginPath(); ctx.arc(TILE_SIZE/2, TILE_SIZE/2, TILE_SIZE*0.35, 0, Math.PI*2); ctx.fill();
            ctx.strokeStyle = '#87CEEB'; ctx.lineWidth = TILE_SIZE*0.05; ctx.stroke();
            ctx.fillStyle = '#FFFFFF'; 
            ctx.fillRect(TILE_SIZE/2 - TILE_SIZE*0.03, TILE_SIZE/2 - TILE_SIZE*0.25, TILE_SIZE*0.06, TILE_SIZE*0.3);
            ctx.fillRect(TILE_SIZE/2 - TILE_SIZE*0.2, TILE_SIZE/2 - TILE_SIZE*0.03, TILE_SIZE*0.25, TILE_SIZE*0.06);
            for(let i=0; i<6; i++){ ctx.beginPath(); ctx.moveTo(TILE_SIZE/2, TILE_SIZE/2); ctx.lineTo(TILE_SIZE/2 + Math.cos(i*Math.PI/3)*TILE_SIZE*0.3, TILE_SIZE/2 + Math.sin(i*Math.PI/3)*TILE_SIZE*0.3); ctx.strokeStyle='rgba(200,220,255,0.8)'; ctx.lineWidth=2; ctx.stroke();}
            return spriteCanvas;
        }
        function createPathfinderSprite() {
            const spriteCanvas = document.createElement('canvas'); spriteCanvas.width = TILE_SIZE; spriteCanvas.height = TILE_SIZE; const ctx = spriteCanvas.getContext('2d');
            ctx.fillStyle = '#FFD700'; 
            ctx.beginPath(); ctx.moveTo(TILE_SIZE/2, TILE_SIZE*0.15); ctx.lineTo(TILE_SIZE*0.65, TILE_SIZE*0.35); ctx.lineTo(TILE_SIZE*0.55, TILE_SIZE*0.35); ctx.lineTo(TILE_SIZE*0.55, TILE_SIZE*0.85);
            ctx.lineTo(TILE_SIZE*0.45, TILE_SIZE*0.85); ctx.lineTo(TILE_SIZE*0.45, TILE_SIZE*0.35); ctx.lineTo(TILE_SIZE*0.35, TILE_SIZE*0.35); ctx.closePath(); ctx.fill();
            ctx.strokeStyle = '#B8860B'; ctx.lineWidth=2; ctx.stroke();
            return spriteCanvas;
        }
        function createCursedIdolSprite() {
            const spriteCanvas = document.createElement('canvas'); spriteCanvas.width = TILE_SIZE; spriteCanvas.height = TILE_SIZE; const ctx = spriteCanvas.getContext('2d');
            ctx.fillStyle = '#4B0082'; 
            ctx.beginPath(); ctx.moveTo(TILE_SIZE*0.5, TILE_SIZE*0.2); ctx.lineTo(TILE_SIZE*0.7, TILE_SIZE*0.8); ctx.lineTo(TILE_SIZE*0.3, TILE_SIZE*0.8); ctx.closePath(); ctx.fill();
            ctx.fillStyle = '#8A2BE2'; 
            ctx.beginPath(); ctx.arc(TILE_SIZE*0.5, TILE_SIZE*0.3, TILE_SIZE*0.05, 0, Math.PI*2); ctx.fill();
            return spriteCanvas;
        }


        function createCDPickupEffect(x, y, isGolden) { 
            const particleCount = 20; const baseColor = isGolden ? [255,215,0] : [220,220,220];
            for(let i=0;i<particleCount;i++){particles.push({renderX:x,renderY:y,size:Math.random()*2.5+1.5,speedX:(Math.random()-0.5)*0.8,speedY:(Math.random()-0.5)*0.8-0.3,color:`rgba(${baseColor[0]},${baseColor[1]},${baseColor[2]},${Math.random()*0.6+0.4})`,alpha:1,life:Math.random()*25+25});}
        }
        function updateParticles() { 
            for(let i=particles.length-1;i>=0;i--){const p=particles[i];p.renderX+=p.speedX*(TILE_SIZE/16);p.renderY+=p.speedY*(TILE_SIZE/16);p.alpha-=0.04;p.life--;if(p.life<=0||p.alpha<=0){particles.splice(i,1);}}
        }
        function drawParticles() { 
            particles.forEach(p=>{const dx=p.renderX-player.x,dy=p.renderY-player.y,distToParticle=Math.hypot(dx,dy);
                if(distToParticle<TILE_SIZE*8&&distToParticle>0.05){let particleAngle=Math.atan2(dy,dx)-player.angle;particleAngle=(particleAngle+Math.PI*2)%(Math.PI*2);if(particleAngle>Math.PI)particleAngle-=Math.PI*2;
                if(Math.abs(particleAngle)<FOV/1.2){const particleScreenX=RENDER_WIDTH/2+(particleAngle/(FOV/2))*(RENDER_WIDTH/2),particleScreenY=RENDER_HEIGHT/2-(p.size*TILE_SIZE/distToParticle/2)+(TILE_SIZE/distToParticle*2),particleSizeOnScreen=Math.max(1,(p.size*TILE_SIZE)/(distToParticle*2.5));
                offscreenCtx.globalAlpha=Math.max(0,p.alpha);offscreenCtx.fillStyle=p.color;offscreenCtx.fillRect(particleScreenX-particleSizeOnScreen/2,particleScreenY-particleSizeOnScreen/2,particleSizeOnScreen,particleSizeOnScreen);offscreenCtx.globalAlpha=1;}}});
        }

        const MAP_DATA = [ 
            [1,1,1,1,1,1,1,1,1,1,1,1,1,1],[1,0,0,0,1,0,0,0,1,0,0,0,0,1],[1,0,1,0,1,0,1,0,1,1,0,1,0,1],
            [1,0,1,0,0,0,1,0,0,0,0,1,0,1],[1,0,1,1,1,1,1,1,1,0,1,1,0,1],[1,0,0,0,0,0,0,0,1,0,0,0,0,1],
            [1,1,1,0,1,1,0,0,1,1,0,1,1,1],[1,0,0,0,1,0,0,0,0,0,0,0,0,1],[1,0,1,1,1,0,1,1,1,1,0,1,0,1],
            [1,0,0,0,0,0,0,1,0,0,0,1,0,1],[1,1,1,1,1,1,1,1,1,1,1,1,1,1],
        ];
        const MAP_WIDTH = MAP_DATA[0].length, MAP_HEIGHT = MAP_DATA.length;

        function triggerPAAnnouncement(){ 
            if(!gameRunning) return;
            const randomIndex = Math.floor(Math.random() * paAnnouncementsList.length);
            messageDisplay.textContent = paAnnouncementsList[randomIndex];
        }
        
        function findEmptyTiles(){ const e=[];for(let y=0;y<MAP_HEIGHT;y++)for(let x=0;x<MAP_WIDTH;x++)if(gameMap[y][x]===0&&Math.hypot((x+0.5)*TILE_SIZE-player.x,(y+0.5)*TILE_SIZE-player.y)>TILE_SIZE*2.5)e.push({x,y});return e;}
        
        function spawnPowerUp(itemPosition, type) {
            if (itemPosition.active) return; 
            const emptyTiles = findEmptyTiles();
            if (emptyTiles.length > 0) {
                const newPos = emptyTiles[Math.floor(Math.random() * emptyTiles.length)];
                itemPosition.x = (newPos.x + 0.5) * TILE_SIZE;
                itemPosition.y = (newPos.y + 0.5) * TILE_SIZE;
                itemPosition.active = true;
                itemPosition.type = type; 
            }
        }

        function spawnGooPuddle() {
            if (gooPuddles.length < MAX_GOO_PUDDLES) {
                const emptyTiles = findEmptyTiles();
                if (emptyTiles.length > 0) {
                    const newPos = emptyTiles[Math.floor(Math.random() * emptyTiles.length)];
                    gooPuddles.push({
                        x: (newPos.x + 0.5) * TILE_SIZE,
                        y: (newPos.y + 0.5) * TILE_SIZE,
                        active: true,
                        type: 'goo' 
                    });
                }
            }
        }

        function respawnCD() { 
            const emptyTiles = findEmptyTiles();
            if (emptyTiles.length > 0) {
                const newPos = emptyTiles[Math.floor(Math.random() * emptyTiles.length)];
                cdPosition.x = (newPos.x + 0.5) * TILE_SIZE;
                cdPosition.y = (newPos.y + 0.5) * TILE_SIZE;
                cdPosition.active = true;

                if (regularCDsCollectedForGoldenTrigger >= nextGoldenCDAfter) {
                    cdPosition.isGolden = true;
                    regularCDsCollectedForGoldenTrigger = 0; 
                    nextGoldenCDAfter = Math.floor(Math.random() * 6) + 2; // 2-7 for next one
                    messageDisplay.textContent = "A GOLDEN CD APPEARS!";
                } else {
                    cdPosition.isGolden = false;
                }
            } else { cdPosition.active = false; console.warn("No space for CD!"); }
            
            if (!timeFreezePosition.active && Math.random() < POWERUP_SPAWN_CHANCE) spawnPowerUp(timeFreezePosition, 'timeFreeze');
            if (!pathfinderPosition.active && Math.random() < POWERUP_SPAWN_CHANCE) spawnPowerUp(pathfinderPosition, 'pathfinder');
            if (!cursedIdolPosition.active && Math.random() < POWERUP_SPAWN_CHANCE * 0.7) spawnPowerUp(cursedIdolPosition, 'cursedIdol'); 
            
            if (gooPuddles.length < MAX_GOO_PUDDLES && Math.random() < 0.15) { 
                spawnGooPuddle();
            }
        }
        
        function updateTimerDisplay(){
            timerDisplay.textContent=`Time: ${timeLeft}`;
            const percentage = (timeLeft / INITIAL_TIME) * 100; 
            timerProgressBar.style.width = `${percentage}%`;

            if (percentage <= 25) { 
                timerProgressBar.style.backgroundColor = '#FF4136'; 
            } else if (percentage <= 60) { 
                timerProgressBar.style.backgroundColor = '#FFDC00'; 
            } else { 
                timerProgressBar.style.backgroundColor = '#2ECC40'; 
            }
        }
        function updateScoreDisplay(){scoreDisplay.textContent=`CDs: ${score}`; }

        function setMainCanvasDimensions() {
            mainCanvas.width = gameplayScreen.clientWidth;
            mainCanvas.height = gameplayScreen.clientHeight;
        }

        function generateShareableScoreGraphic() {
            const graphicCanvas = document.createElement('canvas');
            const graphicWidth = 405; 
            const graphicHeight = 720;
            graphicCanvas.width = graphicWidth;
            graphicCanvas.height = graphicHeight;
            const ctx = graphicCanvas.getContext('2d');
            ctx.imageSmoothingEnabled = false;

            const brickWidth = 32, brickHeight = 16;
            const mortarColor = '#1A1A1A', brickColor1 = '#0A0A0A', brickColor2 = '#050505'; 
            ctx.fillStyle = mortarColor; ctx.fillRect(0, 0, graphicWidth, graphicHeight);
            for (let r = 0; r < graphicHeight / brickHeight; r++) {
                for (let c = 0; c < graphicWidth / brickWidth + 1; c++) {
                    ctx.fillStyle = (r + c) % 3 === 0 ? brickColor2 : brickColor1; 
                    let xOffset = (r % 2 === 0) ? 0 : -brickWidth / 2;
                    ctx.fillRect(c * brickWidth + xOffset, r * brickHeight, brickWidth -2 , brickHeight -2 );
                }
            }
            const vignetteGradient = ctx.createRadialGradient(graphicWidth/2, graphicHeight/2, graphicHeight/4, graphicWidth/2, graphicHeight/2, graphicHeight/1.5);
            vignetteGradient.addColorStop(0, 'rgba(0,0,0,0)'); vignetteGradient.addColorStop(1, 'rgba(0,0,0,0.7)');
            ctx.fillStyle = vignetteGradient; ctx.fillRect(0,0,graphicWidth,graphicHeight);

            ctx.textAlign = "center"; ctx.textBaseline = "middle";
            
            const millosY = graphicHeight * 0.15; 
            ctx.font = "700 18px 'Press Start 2P'";
            ctx.fillStyle = "#800080"; 
            ctx.fillText("Millo's", graphicWidth / 2 + 2, millosY + 2); 
            ctx.fillStyle = "#FFF0F5"; 
            ctx.fillText("Millo's", graphicWidth / 2, millosY);

            const htwBaseY = graphicHeight * 0.25; 
            const lineHeight = 36; 
            const hitTheWallFontSize = 32; 
            ctx.font = `700 ${hitTheWallFontSize}px 'Press Start 2P'`; 
            
            ctx.fillStyle = "#FF1493"; 
            ctx.fillText("Hit", graphicWidth / 2 + 3, htwBaseY + 3); 
            ctx.fillText("The", graphicWidth / 2 + 3, htwBaseY + lineHeight + 3); 
            ctx.fillText("Wall", graphicWidth / 2 + 3, htwBaseY + lineHeight * 2 + 3); 
            ctx.fillStyle = "#FFFF00"; 
            ctx.fillText("Hit", graphicWidth / 2, htwBaseY);
            ctx.fillText("The", graphicWidth / 2, htwBaseY + lineHeight);
            ctx.fillText("Wall", graphicWidth / 2, htwBaseY + lineHeight * 2);
            
            const survivedY = graphicHeight * 0.48; 
            ctx.font = "700 20px 'Press Start 2P'";
            ctx.fillStyle = "#FFFFFF";
            ctx.fillText("Survived:", graphicWidth / 2, survivedY - 18);
            ctx.font = "700 40px 'Press Start 2P'";
            ctx.fillStyle = "#FFFF00";
            ctx.fillText(totalTimePlayedInSeconds + "s", graphicWidth / 2, survivedY + 25);


            const scoreTextY = graphicHeight * 0.62; 
            ctx.font = "700 20px 'Press Start 2P'"; 
            ctx.fillStyle = "#FFFFFF";
            ctx.fillText("Collected:", graphicWidth / 2, scoreTextY - 18);
            
            ctx.font = "700 40px 'Press Start 2P'"; 
            ctx.fillStyle = "#FFFF00";
            ctx.fillText(score, graphicWidth / 2, scoreTextY + 25);
            ctx.font = "700 20px 'Press Start 2P'"; 
            ctx.fillStyle = "#FFFFFF";
            ctx.fillText("CDs!", graphicWidth / 2, scoreTextY + 60);

            const cdSpriteForShare = createReflectiveCDSpriteEnhanced(60); 
            ctx.drawImage(cdSpriteForShare, graphicWidth/2 - 30, scoreTextY + 100, 60, 60);

            const promoY = graphicHeight * 0.90;
            ctx.font = "10px 'Press Start 2P'"; ctx.fillStyle = "#B0B0D0";
            ctx.fillText("Play Millo's 'Hit The Wall'", graphicWidth / 2, promoY);

            const dataUrl = graphicCanvas.toDataURL('image/png');
            const newWindow = window.open();
            if (newWindow) {
                newWindow.document.write(`<body style="margin:0; background:#111;"><img src="${dataUrl}" alt="Millo's Hit The Wall Score" style="display:block; margin:auto; max-width:100%; max-height:100vh;"></body>`);
            } else {
                console.warn("Could not open new window for score graphic. Pop-up blocker?");
            }
        }
        
        function manageMusic(trackToPlay) {
            const allMusic = [menuMusic, gameplayMusic, endMenuMusic];
            allMusic.forEach(audioEl => {
                if (audioEl && audioEl !== trackToPlay) { 
                    if (audioEl.duration > 0 && !audioEl.paused) {
                        audioEl.pause();
                        audioEl.currentTime = 0;
                    }
                }
            });
            if (trackToPlay && trackToPlay.paused) {
                trackToPlay.play().catch(error => console.log(`${trackToPlay.id} play error:`, error));
            }
        }


        async function startGameSequence(){ 
            titleScreen.classList.add('hidden');
            gameOverScreen.classList.add('hidden');
            gameplayScreen.classList.remove('hidden'); 
            gameplayScreen.style.display = 'flex'; 
            onScreenControls.style.display = window.innerWidth <= 768 ? 'flex' : 'none'; 
            
            setMainCanvasDimensions(); 
            offscreenCanvas.width = RENDER_WIDTH; 
            offscreenCanvas.height = RENDER_HEIGHT;

            initGame();
            gameRunning=true;
            totalTimePlayedInSeconds = 0; 
            lastTime=performance.now();
            if (animationFrameId) cancelAnimationFrame(animationFrameId); 
            animationFrameId = requestAnimationFrame(gameLoop);

            if (gameTimerInterval) clearInterval(gameTimerInterval); 
            gameTimerInterval=setInterval(()=>{
                if (!isTimeFrozen) { 
                    timeLeft--;
                    totalTimePlayedInSeconds++;
                }
                updateTimerDisplay();
                if(timeLeft<=0) endGame();
            },1000);
            manageMusic(gameplayMusic);
        }

        async function endGame(){ 
            gameRunning=false; 
            clearInterval(gameTimerInterval); 
            if(xRayTimerId) clearTimeout(xRayTimerId); isXRayModeActive = false;
            if(slowdownTimerId) clearTimeout(slowdownTimerId); isSlowed = false; MOVE_SPEED = ORIGINAL_MOVE_SPEED;
            if(timeFreezeEffectTimerId) clearTimeout(timeFreezeEffectTimerId); isTimeFrozen = false;
            if(pathfinderTimerId) clearTimeout(pathfinderTimerId); isPathfinderActive = false;
            if(fogTimerId) clearTimeout(fogTimerId); isFogActive = false;

            if(paAnnouncementTimer) clearInterval(paAnnouncementTimer);
            
            gameplayScreen.classList.add('hidden'); 
            gameplayScreen.style.display = 'none';
            onScreenControls.style.display = 'none'; 
            gameOverScreen.classList.remove('hidden');
            
            finalScoreDisplay.textContent = `${totalTimePlayedInSeconds}s Survived`;
            statRegularCDs.textContent = regularCDsCollectedThisRound; // Use the correct variable
            statGoldenCDs.textContent = goldenCDsCollectedCount;
            statTimeFreezes.textContent = timeFreezeCollectedCount;
            statPathfinders.textContent = pathfinderCollectedCount;
            statCursedIdols.textContent = cursedIdolsCollectedCount;
            statGooPuddles.textContent = gooPuddlesSteppedOnCount;

            gameOverMessage.textContent = `You lasted ${totalTimePlayedInSeconds}s and found ${score} total value in CDs!`; 

            manageMusic(endMenuMusic);
        }

        function initGame(){ 
            offscreenCanvas.width=RENDER_WIDTH; offscreenCanvas.height=RENDER_HEIGHT; 
            offscreenCtx.imageSmoothingEnabled=false;
            particles = []; 
            gooPuddles = [];
            xraySpecsPosition.active = false;
            timeFreezePosition.active = false;
            pathfinderPosition.active = false;
            cursedIdolPosition.active = false;

            isXRayModeActive = false; if(xRayTimerId) clearTimeout(xRayTimerId);
            isSlowed = false; MOVE_SPEED = ORIGINAL_MOVE_SPEED; if(slowdownTimerId) clearTimeout(slowdownTimerId);
            isTimeFrozen = false; if(timeFreezeEffectTimerId) clearTimeout(timeFreezeEffectTimerId);
            isPathfinderActive = false; if(pathfinderTimerId) clearTimeout(pathfinderTimerId);
            isFogActive = false; if(fogTimerId) clearTimeout(fogTimerId);


            gameMap=MAP_DATA.map(r=>[...r]);let pP=0;
            for(let y=0;y<MAP_HEIGHT;y++){for(let x=0;x<MAP_WIDTH;x++)if(!pP&&gameMap[y][x]===0){player.x=(x+0.5)*TILE_SIZE;player.y=(y+0.5)*TILE_SIZE;player.angle=Math.PI/2;pP=1;break;}if(pP)break;}
            score=0; 
            timeLeft=INITIAL_TIME; 
            totalTimePlayedInSeconds = 0;
            goldenCDsCollectedCount = 0;
            regularCDsCollectedThisRound = 0;
            timeFreezeCollectedCount = 0;
            pathfinderCollectedCount = 0;
            cursedIdolsCollectedCount = 0;
            gooPuddlesSteppedOnCount = 0;

            regularCDsCollectedForGoldenTrigger = 0; 
            nextGoldenCDAfter = GOLDEN_CD_BASE_THRESHOLD; 
            goldenCDSpawnedThisGame = false; 


            updateScoreDisplay();updateTimerDisplay();respawnCD(); 
            messageDisplay.textContent="Stay Alive! Collect CDs!"; 
            if(paAnnouncementTimer)clearInterval(paAnnouncementTimer);
            paAnnouncementTimer=setInterval(triggerPAAnnouncement,PA_ANNOUNCEMENT_INTERVAL);
            setTimeout(triggerPAAnnouncement,3500);
        }
        
        const keys={};
        function handleTouchControl(key, isPressed, buttonElement) { 
            keys[key] = isPressed;
            if (buttonElement) {
                if (isPressed) {
                    buttonElement.classList.add('active');
                } else {
                    buttonElement.classList.remove('active');
                }
            }
        }

        arrowUpButton.addEventListener('touchstart', (e) => { e.preventDefault(); handleTouchControl('arrowup', true, arrowUpButton); });
        arrowUpButton.addEventListener('touchend', (e) => { e.preventDefault(); handleTouchControl('arrowup', false, arrowUpButton); });
        arrowDownButton.addEventListener('touchstart', (e) => { e.preventDefault(); handleTouchControl('arrowdown', true, arrowDownButton); });
        arrowDownButton.addEventListener('touchend', (e) => { e.preventDefault(); handleTouchControl('arrowdown', false, arrowDownButton); });
        arrowLeftButton.addEventListener('touchstart', (e) => { e.preventDefault(); handleTouchControl('arrowleft', true, arrowLeftButton); });
        arrowLeftButton.addEventListener('touchend', (e) => { e.preventDefault(); handleTouchControl('arrowleft', false, arrowLeftButton); });
        arrowRightButton.addEventListener('touchstart', (e) => { e.preventDefault(); handleTouchControl('arrowright', true, arrowRightButton); });
        arrowRightButton.addEventListener('touchend', (e) => { e.preventDefault(); handleTouchControl('arrowright', false, arrowRightButton); });
        
        arrowUpButton.addEventListener('mousedown', () => handleTouchControl('arrowup', true, arrowUpButton));
        arrowUpButton.addEventListener('mouseup', () => handleTouchControl('arrowup', false, arrowUpButton));
        arrowDownButton.addEventListener('mousedown', () => handleTouchControl('arrowdown', true, arrowDownButton));
        arrowDownButton.addEventListener('mouseup', () => handleTouchControl('arrowdown', false, arrowDownButton));
        arrowLeftButton.addEventListener('mousedown', () => handleTouchControl('arrowleft', true, arrowLeftButton));
        arrowLeftButton.addEventListener('mouseup', () => handleTouchControl('arrowleft', false, arrowLeftButton));
        arrowRightButton.addEventListener('mousedown', () => handleTouchControl('arrowright', true, arrowRightButton));
        arrowRightButton.addEventListener('mouseup', () => handleTouchControl('arrowright', false, arrowRightButton));


        window.addEventListener('keydown',(e)=>{
            keys[e.key.toLowerCase()]=true;
            if (e.key === 'Enter' && !gameRunning && titleScreen.classList.contains('hidden') === false) {
                startGameSequence();
            }
        });
        titleScreen.addEventListener('click', () => { 
             if (!gameRunning && titleScreen.classList.contains('hidden') === false) {
                startGameSequence();
            }
        });
        window.addEventListener('keyup',(e)=>keys[e.key.toLowerCase()]=false);
        
        function handleInput(){ if(!gameRunning)return;let dx=0,dy=0;
            const currentMoveSpeed = isSlowed ? ORIGINAL_MOVE_SPEED / 2 : ORIGINAL_MOVE_SPEED; 
            if(keys['arrowup']||keys['w']){dx+=Math.cos(player.angle)*currentMoveSpeed;dy+=Math.sin(player.angle)*currentMoveSpeed;}
            if(keys['arrowdown']||keys['s']){dx-=Math.cos(player.angle)*currentMoveSpeed;dy-=Math.sin(player.angle)*currentMoveSpeed;}
            if(keys['arrowleft']||keys['a'])player.angle-=TURN_SPEED;if(keys['arrowright']||keys['d'])player.angle+=TURN_SPEED;
            player.angle=(player.angle+Math.PI*2)%(Math.PI*2);
            const nPX=player.x+dx,nPY=player.y+dy,pTX=Math.floor(nPX/TILE_SIZE),pTY=Math.floor(nPY/TILE_SIZE);
            if(gameMap[pTY]&&gameMap[pTY][pTX]===0){player.x=nPX;player.y=nPY;}
            else{const pTXC=Math.floor(player.x/TILE_SIZE),pTYC=Math.floor(player.y/TILE_SIZE);
                if(gameMap[pTYC]&&gameMap[pTYC][pTX]===0)player.x=nPX;if(gameMap[pTY]&&gameMap[pTY][pTXC]===0)player.y=nPY;}
            
            // CD Collection
            if(cdPosition.active&&Math.hypot(player.x-cdPosition.x,player.y-cdPosition.y)<TILE_SIZE*0.65){
                const isGoldenHit = cdPosition.isGolden;
                createCDPickupEffect(cdPosition.x, cdPosition.y, isGoldenHit); 
                if (isGoldenHit) {
                    score += GOLDEN_CD_POINTS_VALUE; 
                    timeLeft += TIME_PER_GOLDEN_CD;
                    goldenCdPickupSound.currentTime = 0; goldenCdPickupSound.play(); 
                    messageDisplay.textContent = `GOLDEN CD! +${TIME_PER_GOLDEN_CD} Sec!`;
                    goldenCDsCollectedCount++;
                    regularCDsCollectedForGoldenTrigger = 0; 
                    nextGoldenCDAfter = Math.floor(Math.random() * 6) + 2; 
                } else {
                    score++;
                    timeLeft += TIME_PER_CD;
                    cdPickupSound.currentTime = 0; cdPickupSound.play(); 
                    regularCDsCollectedForGoldenTrigger++;
                    regularCDsCollectedThisRound++; 
                    messageDisplay.textContent = `CD! +${TIME_PER_CD} Sec!`;
                }
                updateScoreDisplay(); updateTimerDisplay(); cdPosition.active=false;
                setTimeout(()=>{if(gameRunning)respawnCD();},100);
            }

            // Power-up / Power-down Collections
            const items = [timeFreezePosition, pathfinderPosition, cursedIdolPosition]; 
            items.forEach(item => {
                if (item.active && Math.hypot(player.x - item.x, player.y - item.y) < TILE_SIZE * 0.6) {
                    item.active = false;
                    switch(item.type) {
                        case 'timeFreeze':
                            isTimeFrozen = true; timeFreezeCollectedCount++;
                            timeFreezeSound.currentTime = 0; timeFreezeSound.play();
                            messageDisplay.textContent = "TIME FROZEN!";
                            if(timeFreezeEffectTimerId) clearTimeout(timeFreezeEffectTimerId);
                            timeFreezeEffectTimerId = setTimeout(() => { isTimeFrozen = false; messageDisplay.textContent = "Time Resumes!";}, TIME_FREEZE_DURATION);
                            break;
                        case 'pathfinder':
                            isPathfinderActive = true; pathfinderCollectedCount++;
                            pathfinderSound.currentTime = 0; pathfinderSound.play();
                            messageDisplay.textContent = "CD BEACON ACTIVE!";
                            if(pathfinderTimerId) clearTimeout(pathfinderTimerId);
                            pathfinderTimerId = setTimeout(() => { isPathfinderActive = false; messageDisplay.textContent = "Beacon Faded."; }, PATHFINDER_DURATION);
                            break;
                        case 'cursedIdol': 
                            isFogActive = true; cursedIdolsCollectedCount++;
                            cursedIdolSound.currentTime = 0; cursedIdolSound.play();
                            messageDisplay.textContent = "CURSED! VISIBILITY REDUCED!";
                            if(fogTimerId) clearTimeout(fogTimerId);
                            fogTimerId = setTimeout(() => { isFogActive = false; messageDisplay.textContent = "Curse Lifted!"; }, FOG_DURATION); 
                            break;
                    }
                }
            });

            // Goo Puddle Collision
            for (let i = gooPuddles.length - 1; i >= 0; i--) {
                const puddle = gooPuddles[i];
                if (puddle.active && Math.hypot(player.x - puddle.x, player.y - puddle.y) < TILE_SIZE * 0.5) {
                    if (!isSlowed) { 
                        isSlowed = true; gooPuddlesSteppedOnCount++;
                        gooPuddleSound.currentTime = 0; gooPuddleSound.play();
                        messageDisplay.textContent = "SLOWED DOWN BY GOO!";
                        if(slowdownTimerId) clearTimeout(slowdownTimerId);
                        slowdownTimerId = setTimeout(() => { isSlowed = false; messageDisplay.textContent = "Speed back to normal!"; }, SLOWDOWN_DURATION);
                    }
                    gooPuddles.splice(i, 1); 
                }
            }
        }

        function render(){
            if (!gameRunning) return; 

            offscreenCanvas.width = RENDER_WIDTH;
            offscreenCanvas.height = RENDER_HEIGHT;

            offscreenCtx.drawImage(textures.ceiling,0,0,RENDER_WIDTH,RENDER_HEIGHT/2);offscreenCtx.drawImage(textures.floor,0,RENDER_HEIGHT/2,RENDER_WIDTH,RENDER_HEIGHT/2);
            for(let i=0;i<NUM_RAYS;i++){const rA=player.angle-FOV/2+(i/NUM_RAYS)*FOV;let dTW=0,hW=0,hE=0;const eX=Math.cos(rA),eY=Math.sin(rA);
                while(!hW&&dTW<TILE_SIZE*MAP_WIDTH){dTW+=1;const tX=Math.floor((player.x+eX*dTW)/TILE_SIZE),tY=Math.floor((player.y+eY*dTW)/TILE_SIZE);
                    if(tX<0||tX>=MAP_WIDTH||tY<0||tY>=MAP_HEIGHT){hW=1;dTW=TILE_SIZE*MAP_WIDTH;}
                    else if(gameMap[tY][tX]===1){hW=1;const bMX=tX*TILE_SIZE+TILE_SIZE/2,bMY=tY*TILE_SIZE+TILE_SIZE/2,rPX=player.x+eX*dTW,rPY=player.y+eY*dTW;const tAng=Math.atan2(rPY-bMY,rPX-bMX);
                        if(tAng>=-Math.PI*0.25&&tAng<Math.PI*0.25)hE=0;else if(tAng>=Math.PI*0.25&&tAng<Math.PI*0.75)hE=1;else if(tAng<-Math.PI*0.25&&tAng>=-Math.PI*0.75)hE=1;else hE=0;}}
                const cD=dTW*Math.cos(rA-player.angle),wH=Math.min(RENDER_HEIGHT,(TILE_SIZE/cD)*RENDER_HEIGHT);const wT=(RENDER_HEIGHT/2)-wH/2,wHX=player.x+eX*dTW,wHY=player.y+eY*dTW;
                let tXx=Math.floor(hE?wHX%TILE_SIZE:wHY%TILE_SIZE);
                
                if (isXRayModeActive) {
                    offscreenCtx.globalAlpha = 0.2; 
                    offscreenCtx.drawImage(textures.wall,tXx,0,1,TILE_SIZE,i,wT,1,wH);
                    offscreenCtx.globalAlpha = 1;
                    offscreenCtx.strokeStyle = XRAY_WALL_OUTLINE_COLOR;
                    offscreenCtx.lineWidth = 0.5; 
                    offscreenCtx.strokeRect(i + 0.25, wT + 0.25, 0.5, wH - 0.5); 
                } else {
                    offscreenCtx.drawImage(textures.wall,tXx,0,1,TILE_SIZE,i,wT,1,wH);
                }
                const sF=Math.max(0.05,1-(cD/(TILE_SIZE*6.5)));
                if (!isXRayModeActive) { 
                    offscreenCtx.fillStyle=`rgba(25,0,25,${1-sF*0.85})`;offscreenCtx.fillRect(i,wT,1,wH);
                }
                distToWallBuffer[i] = cD; 
            }
            
            const itemsToDraw = [cdPosition, timeFreezePosition, pathfinderPosition, cursedIdolPosition, ...gooPuddles];
            itemsToDraw.sort((a,b) => Math.hypot(b.x-player.x, b.y-player.y) - Math.hypot(a.x-player.x, a.y-player.y)); 

            itemsToDraw.forEach(item => {
                if(item.active){
                    const dX=item.x-player.x,dY=item.y-player.y,dTS=Math.hypot(dX,dY);
                    let sA=(Math.atan2(dY,dX)-player.angle+Math.PI*2)%(Math.PI*2);if(sA>Math.PI)sA-=Math.PI*2;
                    
                    let itemSprite = textures.cdSprite;
                    let spriteScaleFactor = item.isGolden ? 0.75 : 0.65;
                    if (item.type === 'goo') { itemSprite = textures.gooPuddleSprite; spriteScaleFactor = 0.5; } 
                    else if (item.type === 'timeFreeze') { itemSprite = textures.timeFreezeSprite; spriteScaleFactor = 0.45; }
                    else if (item.type === 'pathfinder') { itemSprite = textures.pathfinderSprite; spriteScaleFactor = 0.45; }
                    else if (item.type === 'cursedIdol') { itemSprite = textures.cursedIdolSprite; spriteScaleFactor = 0.4; }
                    else if (item.isGolden) { itemSprite = textures.goldenCdSprite; }


                    const sS=Math.min(RENDER_HEIGHT,(TILE_SIZE/dTS)*RENDER_HEIGHT * spriteScaleFactor); 
                    
                    if(Math.abs(sA)<FOV/2+0.35){
                        const sSX=RENDER_WIDTH/2+(sA/(FOV/2))*(RENDER_WIDTH/2)-sS/2;
                        let sSY=(RENDER_HEIGHT/2)-sS/2+(TILE_SIZE/dTS*3.5); 
                        if(item.type === 'goo') { 
                             sSY=RENDER_HEIGHT/2 + (TILE_SIZE*0.4 / dTS) * (RENDER_HEIGHT/2) - sS*0.25; 
                        }


                        if(sSX+sS>0&&sSX<RENDER_WIDTH&&dTS>TILE_SIZE*0.1){
                            let isOccluded = false;
                            const rayIndex = Math.floor(sSX + sS/2);
                            if(rayIndex >=0 && rayIndex < NUM_RAYS){
                                const distToWallAtSpriteAngle = distToWallBuffer[rayIndex] * Math.cos( (rayIndex/NUM_RAYS - 0.5) * FOV );
                                if(dTS > distToWallAtSpriteAngle + TILE_SIZE*0.05) isOccluded = true; 
                            }


                            if(!isOccluded){
                                offscreenCtx.globalAlpha=Math.max(0.5,1-dTS/(TILE_SIZE*12));
                                if (item.type === 'goo') {
                                    offscreenCtx.drawImage(itemSprite,sSX,sSY,sS,sS*0.5); 
                                } else {
                                    let drawSize = sS;
                                    if (item === cdPosition && isPathfinderActive) { 
                                        const pulse = Math.sin(Date.now()/150) * 0.2 + 1.0; 
                                        drawSize *= pulse;
                                        offscreenCtx.shadowColor = 'rgba(255,255,255,0.9)';
                                        offscreenCtx.shadowBlur = 15 * Math.abs(Math.sin(Date.now()/150));
                                    }
                                    offscreenCtx.drawImage(itemSprite,sSX,sSY,drawSize,drawSize);
                                    offscreenCtx.shadowColor = 'transparent'; offscreenCtx.shadowBlur = 0;
                                }
                                offscreenCtx.globalAlpha=1;
                            }
                        }
                    }
                }
            });
            
            if (gameRunning) { 
                updateParticles();
                drawParticles(); 
            }

            // Fog/Darkness Effect
            if (isFogActive) {
                offscreenCtx.fillStyle = 'rgba(10,0,10,0.85)'; 
                offscreenCtx.fillRect(0,0,RENDER_WIDTH, RENDER_HEIGHT);
                offscreenCtx.globalCompositeOperation = 'destination-out';
                const clearRadius = RENDER_WIDTH / 4; 
                offscreenCtx.beginPath();
                offscreenCtx.arc(RENDER_WIDTH/2, RENDER_HEIGHT/2 + RENDER_HEIGHT*0.05, clearRadius, 0, Math.PI*2); 
                offscreenCtx.fill();
                offscreenCtx.globalCompositeOperation = 'source-over';
            }


            const mainCtx=mainCanvas.getContext('2d');mainCtx.imageSmoothingEnabled=false;
            mainCtx.drawImage(offscreenCanvas,0,0,mainCanvas.width,mainCanvas.height);
        }
        let lastTime=0;
        let animationFrameId = null; 
        function gameLoop(ts){
            if(!gameRunning) { 
                if(animationFrameId) cancelAnimationFrame(animationFrameId);
                animationFrameId = null;
                return;
            }
            lastTime=ts;handleInput();render();
            animationFrameId = requestAnimationFrame(gameLoop);
        }
        
        function handleWindowResize() {
            if (gameplayScreen.classList.contains('hidden') === false) { 
                 setMainCanvasDimensions(); 
                 if(gameRunning) render(); 
            }
        }
        window.addEventListener('resize', handleWindowResize);

        restartButton.addEventListener('click',()=> { 
            titleScreen.classList.remove('hidden'); 
            gameOverScreen.classList.add('hidden');
            gameplayScreen.classList.add('hidden'); 
            gameplayScreen.style.display = 'none';
            onScreenControls.style.display = 'none';
            manageMusic(menuMusic); 
        });
        shareScoreButton.addEventListener('click', generateShareableScoreGraphic);
        
        (async()=>{
            drawPixelCursiveLogo();
            manageMusic(menuMusic); 
            console.log("Game initialized.");
            titleScreen.classList.remove('hidden');gameplayScreen.classList.add('hidden');gameOverScreen.classList.add('hidden');
            onScreenControls.style.display = 'none'; 
        })();
    </script>
</body>
</html>
